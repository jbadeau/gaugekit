package corg.gaugekit.screenplay;

/**
 * The stage is used to keep track of the actors taking part in a Screenplay test.
 * It is useful if you don't keep track of the actors explicitly, but just refer to them by name, as is often done
 * in Gauge specs.
 *
 * Actors can be referred to by name (which must be unique for a given actor) or a pronoun.
 * The default pronouns are "he","she","they" and "it", and they are used interchangeably - any pronoun will always
 * refer to last named actor who performed some action.
 * Pronouns can be configured using the screenplay.pronouns property, e.g.
 * <pre>
 *     <code>
 *         screenplay.pronouns = il,elle
 *     </code>
 * </pre>
 *
 * The current stage is kept as a ThreadLocal object, so if you have multiple threads in the same Screenplay test,
 * you need to propagate the stage to each new thread using the setTheStage() method.
 */
public class OnStage {

    private static final ThreadLocal<Stage> STAGE = new ThreadLocal<>();

    /**
     * Set the stage before calling the actors
     */
    public static Stage setTheStage(Cast cast) {
        STAGE.set(new Stage(cast));
        return stage();
    }

    /**
     * Set the stage to a specific stage object.
     * This is rarely needed but sometimes comes in handy when running tasks in parallel.
     */
    public static Stage setTheStage(Stage stage) {
        STAGE.set(stage);
        return stage();
    }

    public static Actor theActorCalled(String requiredActor) {
        if (ScreenplayProperties.getPronouns().contains(requiredActor)) {
            return stage().theActorInTheSpotlight().usingPronoun(requiredActor);
        }
        return stage().shineSpotlightOn(requiredActor);
    }

    private static boolean anActorIsOnStage() {
        return stage().anActorIsOnStage();
    }

    /**
     * The actor in the spotlight is the last actor on the stage who has performed any activity.
     */
    public static Actor theActorInTheSpotlight() {
        return stage().theActorInTheSpotlight();
    }

    /**
     * A shorter version of "theActorInTheSpotlight().attemptsTo(...)"
     */
    public static void withCurrentActor(Task task) {
        theActorInTheSpotlight().attemptTo(task);
    }

    /**
     * Get the current stage. Rarely needed for non-internal use, except when running tasks in parallel.
     * In that case, you will need to call OnStage.setTheStage(stage) in each parallel thread if you use
     * OnStage methods such as theActorInTheSpotlight()
     */
    public static Stage stage() {
        if (STAGE.get() == null) {
            throw new NoStageException("No stage available - it looks like you haven't called the setTheStage() method before calling this one.");
        } else {
            return STAGE.get();
        }
    }

    /**
     * Perform any cleanup actions on each actor on the stage.
     * This calls the `wrapUp()` method if defined on each actor on the stage.
     */
    public static void drawTheCurtain() {
        if (STAGE.get() != null) {
            stage().drawTheCurtain();
        }
    }

}
